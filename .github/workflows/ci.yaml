name: "Continuous Integration"

concurrency:
  group: "ci-${{ github.head_ref || github.run_id }}"
  cancel-in-progress: true

on:
  pull_request:
  push:
    branches:
      - "main"

env:
  fail-fast: true

jobs:
  tests-mysql:
    name: "Integration Tests w/MySQL (PHP ${{ matrix.php-version }}, MySQL ${{ matrix.mysql-version }})"
    runs-on: "ubuntu-22.04"

    container:
        image: "${{ matrix.php-image }}"

    strategy:
      matrix:
        mysql-version:
          - "8.0"
        php-version:
          - "8.1"
          - "8.2"
        include:
            - php-version: "8.1"
              php-image: "php:8.1-cli-alpine"
            - php-version: "8.2"
              php-image: "php:8.2-cli-alpine"

    services:
      mysql:
        image: "mysql:${{ matrix.mysql-version }}"

        options: >-
          --health-cmd "mysqladmin ping --silent" 
          --health-interval=1s 
          --health-timeout=5s 
          --health-retries=90
          -e MYSQL_ALLOW_EMPTY_PASSWORD=yes
          -e MYSQL_DATABASE=tests
          -e MYSQL_INITDB_SKIP_TZINFO=yes
          --entrypoint sh mysql:8 -c "exec docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password"
        ports:
          - "3306:3306"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v3"

      - name: "Install OS dependencies"
        run: "apk add --no-cache bash"

      - name: "Install Composer"
        run: "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin --filename=composer --version=2.5.8"

      - name: "Install Composer dependencies"
        uses: "ramsey/composer-install@v2"

      - name: "Run tests"
        run: "./vendor/bin/phpunit --colors --testsuite=integration --do-not-cache-result --group=MySQL"

  tests-unit:
    name: "Unit Tests (PHP ${{ matrix.php-version }}, dependencies ${{ matrix.composer-dependencies }})"
    runs-on: "ubuntu-22.04"

    container:
        image: "${{ matrix.php-image }}"

    strategy:
      matrix:
        php-version:
          - "8.1"
          - "8.2"
        composer-dependencies:
          - "lowest"
          - "locked"
          - "highest"
        include:
            - php-version: "8.1"
              php-image: "php:8.1-cli-alpine"
            - php-version: "8.2"
              php-image: "php:8.2-cli-alpine"

    steps:
      - name: "Checkout"
        uses: "actions/checkout@v3"

      - name: "Install OS dependencies"
        run: "apk add --no-cache bash"

      - name: "Install Composer"
        run: "curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin --filename=composer --version=2.5.8"

      - name: "Install Composer dependencies"
        uses: "ramsey/composer-install@v2"
        with:
          dependency-versions: "${{ matrix.composer-dependencies }}"

      - name: "Run unit tests"
        run: "./vendor/bin/phpunit --colors --testsuite=unit --do-not-cache-result"
